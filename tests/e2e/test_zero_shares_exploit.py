"""
Minimal PoC: Zero-share deposit vulnerability
"""

import boa
import pytest
from tests.utils import max_approve
from tests.utils.constants import MIN_TICKS


@pytest.fixture(scope="module")
def market_type():
    return "lending"


@pytest.fixture(scope="module")
def borrowed_decimals():
    return 18


@pytest.fixture(scope="module")
def seed_liquidity():
    return 0


def test_zero_shares_exploit(
    vault, controller, amm, borrowed_token, collateral_token, admin, accounts
):
    depositor = accounts[1]
    borrower = accounts[2]
    victim = accounts[3]

    # Initial deposit
    initial_deposit = vault.eval("MIN_ASSETS")
    boa.deal(borrowed_token, depositor, initial_deposit)
    with boa.env.prank(depositor):
        max_approve(borrowed_token, vault.address)
        vault.deposit(initial_deposit)

    # Borrow
    with boa.env.prank(admin):
        controller.set_borrow_cap(10**30)

    collateral_amount = 10000 * 10 ** collateral_token.decimals()
    boa.deal(collateral_token, borrower, collateral_amount)
    with boa.env.prank(borrower):
        max_approve(collateral_token, controller.address)
        max_borrow = controller.max_borrowable(collateral_amount, MIN_TICKS)
        controller.create_loan(collateral_amount, max_borrow, MIN_TICKS)

    # Calculate needed total_assets for zero shares
    DEAD_SHARES = vault.eval("DEAD_SHARES")
    precision = vault.eval("self.precision")
    total_supply = vault.totalSupply()
    test_deposit = 1
    numerator_coeff = (total_supply + DEAD_SHARES) * test_deposit * precision
    min_total_assets = (numerator_coeff // precision) + 1

    # Accrue interest until zero shares
    amm.eval("self.rate = 10**15")  # Very high rate
    amm.eval("self.rate_time = block.timestamp")

    # Keep accruing interest until we reach zero shares
    for i in range(20):
        boa.env.time_travel(365 * 86400 * 100)  # 100 years per iteration
        controller.save_rate()
        preview_shares = vault.previewDeposit(test_deposit)
        if preview_shares == 0:
            break

    # Execute deposit
    boa.deal(borrowed_token, victim, test_deposit)
    with boa.env.prank(victim):
        max_approve(borrowed_token, vault.address)
        with boa.reverts("Can't mint 0 shares"):
            vault.deposit(test_deposit)
